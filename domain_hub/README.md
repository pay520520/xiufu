# WHMCS7 é˜¿é‡Œäº‘DNS äºŒçº§åŸŸååˆ†å‘æ’ä»¶

## ğŸ“¦ æ–‡ä»¶è¯´æ˜

### æ ¸å¿ƒæ–‡ä»¶

- **domain_hub.php** - ä¸»æ’ä»¶æ–‡ä»¶ï¼ˆå«è‡ªåŠ¨æ€§èƒ½ä¼˜åŒ–ï¼‰
- **worker.php** - åå°ä»»åŠ¡å¤„ç†ï¼ˆé£é™©æ‰«æã€æ ¹åŸŸåæ›¿æ¢ç­‰ï¼‰
- **hooks.php** - WHMCSé’©å­å¤„ç†
- **check_activation.php** - æ’ä»¶æ¿€æ´»æ£€æŸ¥
- **cli_settle_invite.php** - å‘½ä»¤è¡Œé‚€è¯·ç»“ç®—å·¥å…·

### æ¨¡æ¿æ–‡ä»¶

- **templates/admin.tpl** - ç®¡ç†åå°ç•Œé¢
- **templates/client.tpl** - ç”¨æˆ·å‰å°ç•Œé¢
- **templates/api_management.tpl** - APIç®¡ç†ç•Œé¢

#### è‡ªå®šä¹‰åå° UI
- åå° UI å·²æ‹†åˆ†ä¸º `templates/admin/partials/*.tpl`ï¼Œé…å¥—æ•°æ®ç»“æ„è¯·å‚è€ƒ `docs/admin_refactor_plan.md`ã€‚
- æ‰©å±•/æ–°å¢å¡ç‰‡æ—¶ï¼Œä»…éœ€åœ¨ `CfAdminViewModelBuilder` å‡†å¤‡æ•°æ®ï¼Œå¹¶åœ¨ `admin.tpl` é¡ºåº `include` ç›¸åº” partialã€‚

### åº“æ–‡ä»¶

- **lib/CloudflareAPI.php** - Cloudflare APIå°è£…
- **lib/ExternalRiskAPI.php** - å¤–éƒ¨é£é™©APIå°è£…

### æ§åˆ¶å±‚ & è‡ªåŠ¨åŠ è½½

- **lib/autoload.php** - æ¨¡å—çº§è‡ªåŠ¨åŠ è½½å™¨ï¼Œç»Ÿä¸€æ³¨å†Œ Service/Repository/Controller
- **lib/Http/AdminController.php** - åå°å…¥å£æ§åˆ¶å™¨ï¼Œè´Ÿè´£è½½å…¥æ¨¡æ¿ã€å¤„ç†è¡¨å•ï¼Œå¹¶å‘æ¨¡æ¿è¾“å‡º ViewModel
- **lib/Http/ClientController.php** - å®¢æˆ·åŒºå…¥å£æ§åˆ¶å™¨ï¼Œå°è£…åŸæœ‰ client.tpl è®¿é—®/æ ¡éªŒ/æ¥å£é€»è¾‘
- **lib/Http/ApiDispatcher.php** - API è¯·æ±‚è°ƒåº¦å™¨ï¼Œå®ç° `cf_is_api_request` ä¸ `cf_dispatch_api_request` çš„ç»Ÿä¸€å…¥å£

### æ¨¡æ¿ç»“æ„

- **templates/admin.tpl** - ä»ä¸ºä¸»æ¨¡æ¿å…¥å£ï¼Œåªè´Ÿè´£æ³¨å…¥å…¨å±€è„šæœ¬/å¸ƒå±€ï¼Œå¹¶é¡ºåº `include` å„åå° partialï¼Œæ¶ˆè´¹ `$cfAdminViewModel`
- **templates/admin/partials/**
  - `alerts.tpl`ã€`stats_cards.tpl`ã€`provider_accounts.tpl`
  - `rootdomains/list.tpl`ã€`rootdomains/form.tpl`
  - `privileged_users.tpl`ã€`job_queue.tpl`ã€`risk_monitor.tpl`ã€`logs.tpl`
  - `api_management.tpl`ï¼ˆåŸæœ‰çš„ API ç®¡ç†åŒºå—ï¼‰
- **templates/client.tpl** - å®¢æˆ·åŒºå…¥å£æ¨¡æ¿ï¼Œå¦‚ä»Šä½œä¸ºè½»é‡å…¥å£é¡ºåº `include` `templates/client/partials/*.tpl`ï¼ˆheaderã€alertsã€messagesã€quota_inviteã€subdomainsã€extrasã€modalsã€scriptsï¼‰ï¼Œè¦†ç›–æ—§ç‰ˆä»å…¼å®¹
- **templates/client/partials/** - å®¢æˆ·åŒº UI çš„ç»“æ„åŒ–ç‰‡æ®µï¼Œå¯æŒ‰éœ€å®šåˆ¶ï¼›å‡çº§æ—¶ä¾æ—§åªéœ€æ›¿æ¢æ•´ä¸ª `templates` ç›®å½•å³å¯

### å¦‚ä½•æ–°å¢ä¸€ä¸ªåå° Partial / ç®¡ç†å¡ç‰‡

1. **å‡†å¤‡æ•°æ®**ï¼šåœ¨ `CfAdminController::buildViewModel()`ï¼ˆæˆ–ç›¸åº” Serviceï¼‰ä¸­è®¡ç®—è¯¥åŒºå—æ‰€éœ€çš„æ•°æ®ï¼Œå¹¶æ”¾å…¥ `$cfAdminViewModel['yourSection']`ã€‚
2. **åˆ›å»º partial**ï¼šåœ¨ `templates/admin/partials/` ä¸‹æ–°å»º `your_section.tpl`ï¼ˆå¦‚æœ‰å­ç»“æ„å¯å»ºå­ç›®å½•ï¼‰ï¼Œæ¨¡æ¿å†…éƒ¨åªè¯»å– `$cfAdminViewModel['yourSection']`ï¼Œç¦æ­¢ç›´æ¥è®¿é—® `Capsule` / superglobalsã€‚
3. **å…¥å£å¼•å…¥**ï¼šåœ¨ `templates/admin.tpl` ä¸­ï¼ŒæŒ‰é¡µé¢é¡ºåº `include __DIR__ . '/admin/partials/your_section.tpl';`ã€‚
4. **è„šæœ¬å½’ä½**ï¼šè‹¥åŒºå—éœ€è¦ JS/æ ·å¼ï¼Œå°† `<script>` æ”¾åœ¨ partial å°¾éƒ¨ï¼ˆæˆ–é›†ä¸­äºå…¥å£å°¾éƒ¨ï¼‰ï¼Œé¿å…å…¨å±€æ±¡æŸ“ã€‚
5. **æµ‹è¯•**ï¼šç¡®è®¤æ‰€æœ‰è¡¨å• actionã€CSRFã€é—ªå­˜æç¤ºä¾æ—§å¥æ•ˆï¼Œå†æäº¤ä»£ç ã€‚

### ä¼˜åŒ–å·¥å…·

- **ç«‹å³ä¼˜åŒ–-æ·»åŠ ç´¢å¼•.sql** - æ•°æ®åº“å®Œæ•´ç´¢å¼•ä¼˜åŒ–ï¼ˆ30+ç´¢å¼•ï¼‰
- **æ€§èƒ½æ£€æŸ¥è„šæœ¬.php** - è‡ªåŠ¨æ€§èƒ½æ£€æŸ¥å·¥å…·
- **database_optimization.sql** - æ•°æ®åº“æ¸…ç†å’Œä¼˜åŒ–
- **optimize_risk_events.php** - é£é™©äº‹ä»¶ä¼˜åŒ–ï¼ˆæ—§ç‰ˆï¼‰
- **optimize_risk_events_v2.php** - é£é™©äº‹ä»¶ä¼˜åŒ–ï¼ˆæ–°ç‰ˆï¼‰
- **performance_monitor.php** - æ€§èƒ½ç›‘æ§å·¥å…·

### æ–‡æ¡£

- **API_DOCUMENTATION.md** - APIä½¿ç”¨æ–‡æ¡£

---

## ğŸš€ å®‰è£…éƒ¨ç½²

### æ–°å®‰è£…ç”¨æˆ·

1. **ä¸Šä¼ æ–‡ä»¶**
   ```
   ä¸Šä¼ æ•´ä¸ª domain_hub æ–‡ä»¶å¤¹åˆ°ï¼š
   /www/wwwroot/your-whmcs/modules/addons/
   ```

2. **æ¿€æ´»æ’ä»¶**
   ```
   WHMCSåå° â†’ è®¾ç½® â†’ ç³»ç»Ÿè®¾ç½® â†’ é™„åŠ ç»„ä»¶ â†’ æ¿€æ´»
   ```

3. **è‡ªåŠ¨ä¼˜åŒ–**
   ```
   âœ… æ¿€æ´»æ—¶è‡ªåŠ¨æ·»åŠ 11ä¸ªæ ¸å¿ƒæ€§èƒ½ä¼˜åŒ–ç´¢å¼•
   âœ… å¼€ç®±å³ç”¨ï¼Œæ— éœ€é¢å¤–æ“ä½œ
   ```

### è€ç”¨æˆ·å‡çº§

1. **å¤‡ä»½æ•°æ®**
   ```bash
   mysqldump -uç”¨æˆ·å -pæ•°æ®åº“å > backup.sql
   ```

2. **ä¸Šä¼ æ–°æ–‡ä»¶**
   ```
   è¦†ç›–æ—§æ–‡ä»¶åˆ°ï¼š
   /www/wwwroot/your-whmcs/modules/addons/domain_hub/


3. **é‡æ–°æ¿€æ´»**
   ```
   WHMCSåå° â†’ åœç”¨ â†’ é‡æ–°æ¿€æ´»
   âœ… è‡ªåŠ¨è¡¥å……ç¼ºå¤±çš„æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
   ```

4. **å¯é€‰ï¼šå®Œæ•´ä¼˜åŒ–**
   ```bash
   mysql -uç”¨æˆ·å -pæ•°æ®åº“å < ç«‹å³ä¼˜åŒ–-æ·»åŠ ç´¢å¼•.sql
   ```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### ç”¨æˆ·åŠŸèƒ½

- âœ… äºŒçº§åŸŸåæ³¨å†Œ
- âœ… DNSè®°å½•ç®¡ç†ï¼ˆAã€AAAAã€CNAMEã€MXã€TXTã€NSã€SRVï¼‰
- âœ… é‚€è¯·ç ç³»ç»Ÿ
- âœ… ç”¨æˆ·é…é¢ç®¡ç†
- âœ… APIå¯†é’¥ç®¡ç†
- âœ… æ’è¡Œæ¦œå’Œå¥–åŠ±

### ç®¡ç†åŠŸèƒ½

- âœ… æ ¹åŸŸåç®¡ç†
- âœ… ç”¨æˆ·é…é¢ç®¡ç†
- âœ… åŸŸåå®¡æ ¸å’Œå°ç¦
- âœ… é£é™©æ‰«æå’Œç›‘æ§
- âœ… APIå¯†é’¥ç®¡ç†
- âœ… æ“ä½œæ—¥å¿—å®¡è®¡

### æ€§èƒ½ä¼˜åŒ–

- âœ… **è‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–**ï¼ˆæ–°åŠŸèƒ½ï¼‰
  - æ¿€æ´»æ—¶è‡ªåŠ¨æ·»åŠ 11ä¸ªæ ¸å¿ƒç´¢å¼•
  - æå‡æ€§èƒ½10-100å€
  - æ™ºèƒ½æ£€æµ‹ï¼Œé¿å…é‡å¤

- âœ… **N+1æŸ¥è¯¢ä¿®å¤**
  - æ’è¡Œæ¦œæŸ¥è¯¢ä¼˜åŒ–
  - é£é™©æ‰«æä¼˜åŒ–
  - æ ¹åŸŸåæ›¿æ¢ä¼˜åŒ–

- âœ… **é…ç½®ç¼“å­˜æœºåˆ¶**
  - é™æ€å˜é‡ç¼“å­˜
  - å‡å°‘æ•°æ®åº“æŸ¥è¯¢

---

## ğŸ“Š æ€§èƒ½æ•°æ®

### ä¼˜åŒ–æ•ˆæœï¼ˆ1000ç”¨æˆ·ï¼Œ5000åŸŸåï¼‰

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| å‰å°åŠ è½½ | 3.5ç§’ | 0.6ç§’ | **5.8å€** |
| åŸŸåæ³¨å†Œ | 4.2ç§’ | 0.8ç§’ | **5.2å€** |
| åå°ç»Ÿè®¡ | 8.5ç§’ | 1.2ç§’ | **7.1å€** |
| æ’è¡Œæ¦œè®¡ç®— | 15ç§’ | 3ç§’ | **5å€** |
| æ•°æ®åº“CPU | 85% | 25% | **é™70%** |

### å¯æ”¯æŒè§„æ¨¡

| ç”¨æˆ·æ•° | åŸŸåæ•° | å“åº”æ—¶é—´ | æ•°æ®åº“CPU |
|--------|--------|---------|-----------|
| 100 | 500 | < 0.3ç§’ | < 10% |
| 1,000 | 5,000 | < 0.8ç§’ | < 20% |
| 10,000 | 50,000 | < 2ç§’ | < 40% |
| **50,000** | **250,000** | < 3ç§’ | < 60% |

---

## ğŸ”§ å¯é€‰ä¼˜åŒ–

### å®Œæ•´ç´¢å¼•ä¼˜åŒ–ï¼ˆæ¨èï¼‰

```bash
# æ·»åŠ 30+ä¸ªæ€§èƒ½ä¼˜åŒ–ç´¢å¼•
mysql -uç”¨æˆ·å -pæ•°æ®åº“å < ç«‹å³ä¼˜åŒ–-æ·»åŠ ç´¢å¼•.sql
```

**æ•ˆæœï¼š** æ€§èƒ½å†æå‡5-50å€

### æ€§èƒ½æ£€æŸ¥

```bash
# æ£€æŸ¥å½“å‰æ€§èƒ½çŠ¶æ€
cd /www/wwwroot/your-whmcs/modules/addons/domain_hub/
php æ€§èƒ½æ£€æŸ¥è„šæœ¬.php
```

### æ•°æ®æ¸…ç†

```bash
# æ¸…ç†é£é™©äº‹ä»¶è¡¨
mysql -uç”¨æˆ·å -pæ•°æ®åº“å < database_optimization.sql
```

---

## ğŸ†• v2.1 æ–°åŠŸèƒ½

### è‡ªåŠ¨æ€§èƒ½ä¼˜åŒ– â­

**ç‰¹æ€§ï¼š**
- âœ… æ¿€æ´»æ—¶è‡ªåŠ¨æ·»åŠ 11ä¸ªæ ¸å¿ƒç´¢å¼•
- âœ… æ™ºèƒ½æ£€æµ‹ï¼Œé¿å…é‡å¤
- âœ… å¼€ç®±å³ç”¨ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ

**ç´¢å¼•åˆ—è¡¨ï¼š**
1. mod_cloudflare_subdomainï¼ˆ3ä¸ªç´¢å¼•ï¼‰
2. mod_cloudflare_dns_recordsï¼ˆ1ä¸ªç´¢å¼•ï¼‰- æœ€é‡è¦
3. mod_cloudflare_invitation_claimsï¼ˆ2ä¸ªç´¢å¼•ï¼‰
4. mod_cloudflare_api_keysï¼ˆ1ä¸ªç´¢å¼•ï¼‰
5. mod_cloudflare_api_logsï¼ˆ2ä¸ªç´¢å¼•ï¼‰
6. mod_cloudflare_domain_riskï¼ˆ2ä¸ªç´¢å¼•ï¼‰

**æ¿€æ´»æç¤ºï¼š**
```
âœ… æ’ä»¶æ¿€æ´»æˆåŠŸï¼Œæ•°æ®åº“è¡¨å·²åˆ›å»º/æ›´æ–°ï¼Œæ‰€æœ‰æ•°æ®å·²ä¿ç•™ï¼Œå·²æ·»åŠ 11ä¸ªæ€§èƒ½ä¼˜åŒ–ç´¢å¼•
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æ€§èƒ½æ£€æŸ¥

```bash
php æ€§èƒ½æ£€æŸ¥è„šæœ¬.php
```

### æ—¥å¿—ä½ç½®

- PHPé”™è¯¯ï¼š`/var/log/php-fpm/error.log`
- MySQLæ…¢æŸ¥è¯¢ï¼š`/var/log/mysql/slow-query.log`
- WHMCSæ—¥å¿—ï¼š`storage/logs/whmcs.log`

### APIæ–‡æ¡£

æŸ¥çœ‹ `API_DOCUMENTATION.md` è·å–å®Œæ•´APIæ–‡æ¡£ã€‚

---

## âœ… ç‰ˆæœ¬ä¿¡æ¯

- **å½“å‰ç‰ˆæœ¬ï¼š** v2.1
- **å‘å¸ƒæ—¥æœŸï¼š** 2025-10-19
- **ä¸»è¦ç‰¹æ€§ï¼š** è‡ªåŠ¨æ€§èƒ½ä¼˜åŒ–ã€N+1æŸ¥è¯¢ä¿®å¤ã€é…ç½®ç¼“å­˜

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v2.1 (2025-10-19)

**æ–°åŠŸèƒ½ï¼š**
- âœ… è‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–ï¼ˆæ¿€æ´»æ—¶è‡ªåŠ¨æ·»åŠ 11ä¸ªæ ¸å¿ƒç´¢å¼•ï¼‰
- âœ… æ€§èƒ½æ£€æŸ¥è„šæœ¬
- âœ… æ™ºèƒ½ç´¢å¼•æ£€æµ‹

**æ€§èƒ½ä¼˜åŒ–ï¼š**
- âœ… ä¿®å¤3ä¸ªN+1æŸ¥è¯¢é—®é¢˜
- âœ… æ·»åŠ é…ç½®ç¼“å­˜æœºåˆ¶
- âœ… ä¼˜åŒ–exists()æŸ¥è¯¢

**æ•ˆæœï¼š**
- æ€§èƒ½æå‡10-100å€
- å¯æ”¯æŒ50,000+ç”¨æˆ·

---

**ğŸ‰ ä»ä»Šå¤©å¼€å§‹ï¼Œæ¯ä¸ªæ–°å®‰è£…éƒ½æ˜¯é«˜æ€§èƒ½ï¼**

